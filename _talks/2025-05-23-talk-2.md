---
title: "深入解析AMM：从CPMM到DLMM的演进之路"
collection: talks
type: "Talk"
permalink: /talks/2025-05-23-talk-2
date: 2025-05-23
location: "花果山水帘洞, 东胜神州"
---

## 引言：传统做市与链上做市的挑战

在传统交易所中，做市商通过不断挂出买卖订单，执行低买高卖的操作来赚取差价。这种模式在中心化交易所运行良好，但在区块链上却面临巨大挑战：

- 高昂的gas费用使得小额订单无利可图
- 链上存储成本高
- 交易竞争激烈
- 订单簿模式在以太坊上难以实现

然而，自动做市商(AMM)的出现彻底改变了这一局面。

> 记得我第一次使用交易所时，天真地以为只要在价格低时买入，稍微上涨就卖出就能稳赚不赔。但很快发现，每次买入后价格就跳涨，卖出后价格就跳跌。后来才明白，这是在给做市商送钱。做市商赚的是差价，虽然单笔利润微薄，但胜在量大。在链上，这种模式因为高昂的gas费用变得不可行，这也催生了AMM的创新。

## 1. CPMM：开创性的恒定乘积模型

### 1.1 核心原理

CPMM的核心公式：

$$
x \cdot y = k
$$

其中：
- \( x \)：池中 Token A 的数量  
- \( y \)：池中 Token B 的数量  
- \( k \)：常数，表示池中流动性的乘积

价格影响(含0.3%手续费)：

$$
\text{amountOut} = \frac{\Delta x \cdot 997 \cdot y}{1000 \cdot x + \Delta x \cdot 997}
$$

<iframe src="./talk2/cpmm.html" width="100%" height="500" frameborder="0"></iframe>

### 1.2 成功要素

CPMM的成功源于两个关键特性：

1. **动态价格调整**
   - 价格会随着交易方向自动调整
   - 防止套利者清空流动性池
   - 确保市场稳定运行

2. **手续费机制**
   - 做市商通过交易手续费获得收益
   - 替代传统做市商的价差收益模式

### 1.3 局限性

CPMM存在两个主要缺点：
- 流动性池深度不均衡
- 资金利用率较低

> 我认为CPMM的诞生是DeFi发展史上的一个里程碑。它不仅解决了链上做市的问题，更重要的是开创了一种全新的交易模式。CPMM的成功在于它用数学模型替代了传统订单簿，让做市商无需不断更新订单。这种创新不仅降低了成本，还提高了效率，为DeFi的爆发奠定了基础。

## 2. CSMM：稳定币交易的理想选择

### 2.1 稳定币交易的特点

- 交易量大
- 汇率稳定（1:1左右）
- 需求均衡

### 2.2 传统CSMM模型

核心公式：

$$
\sum x_i = k
$$

特点：
- 价格固定为1:1
- 无滑点
- 资金利用率高
- 但容易耗尽流动性

### 2.3 Curve的混合模型

Curve V1创新性地结合了CPMM和CSMM的优点：

$$
A \cdot \sum x_i + D = A \cdot D^n + \frac{D^{n+1}}{n^n \cdot \prod x_i}
$$


#### 简化版不变式

$$
A \cdot (x + y)^2 + 4xy = 4A D^2
$$

#### 近似可视化公式

$$
y = D - x + \frac{(x - x_0)^2}{A \cdot D}
$$

<iframe src="./talk2/csmm_curve.html" width="100%" height="500" frameborder="0"></iframe>


特点：
- 价格接近1:1时，曲线接近直线，滑点极低
- 价格偏离较大时，自动转为CPMM形式
- 资金利用率高
- 可调节的曲线形状

> Curve的混合模型本质上是通过数学方法拟合了一个分段函数：在稳定币价格接近1:1时，让交易者享受近似不变的汇率；在价格偏离较大时，自动转为CPMM模式防止套利。这种设计既保证了交易效率，又维护了市场稳定，完美解决了稳定币交易的特殊需求。

## 3. CLMM：提升资金利用率的创新

### 3.1 CPMM的资金利用问题

以ETH/USDC交易对为例：
- 初始价格：2000 USDC/ETH
- 流动性分布：0到无穷大
- 实际交易区间：1000-3000 USDC/ETH
- 大量资金被闲置

### 3.2 CLMM的解决方案

核心公式：

$$
L = \sqrt{P_b} - \sqrt{P_a}
$$

虚拟流动性：

$$
L_v = \frac{L}{\sqrt{P_b} - \sqrt{P_a}}
$$

流动性分布：

$$
(x + \frac{L_v}{\sqrt{P_b}})(y + L_v\sqrt{P_a}) = L_v^2
$$

<iframe src="./talk2/clmm.html" width="100%" height="800" frameborder="0"></iframe>

优势：
1. 流动性集中在特定价格范围
2. 更高的资金利用率
3. 更深的流动性深度

缺点：
CPMM的逻辑非常简单且轻量，与CPMM交互，需要访问的链上数据很少，一次请求就可以获取swap所需的全部数据。而CLMM却需要多次请求，例如获取当前pool的价格区间，区间内的流动性账户等等。这意味着良好的交互体验需要项目方提供及时更新的后台服务，如果仅仅从节点获取数据，就总感觉交互有点迟钝。

> CLMM的突破在于它让做市商能够像在CEX中一样，将资金集中在最可能发生交易的价格区间。通过引入虚拟流动性的概念，CLMM实现了对CPMM曲线的"平移"，使得资金利用率最高的位置可以灵活调整。这种设计让做市商能够更精确地控制风险，提高资金效率。

## 4. DLMM：链上订单簿的实现

DLMM（动态流动性做市商）代表了AMM的最新发展方向：

- 实现类似CEX的订单簿体验
- 支持单边流动性

但是DLMM并没有统一的数学表达和实现方式，只要能够实现类似订单簿模式的链上amm都可以称之为DLMM，因为他们都能让用户动态调整流动性区间。目前最优秀的DLMM实现是Meteora，它成功地将传统订单簿的优势带到了链上。

> DLMM的出现标志着AMM发展进入了一个新阶段。它试图将传统订单簿的优势与AMM的效率结合起来，让做市商能够更灵活地管理流动性。虽然目前还没有统一的实现标准，但这种探索对于DeFi的发展至关重要。Meteora的成功证明了这种模式是可行的，也为未来的创新指明了方向。
